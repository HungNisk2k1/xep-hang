<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>B·∫£ng X·∫øp H·∫°ng B√¨nh Ch·ªçn</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
    <style>
        body { 
            font-family: 'Segoe UI', sans-serif; 
            text-align: center; 
            margin: 20px; 
            background-color: #6a3b1b; 
            color: #c18836; 
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        *{ outline: none !important; caret-color: transparent; }
        .leader { font-weight: bold; font-size: 22px; margin-bottom: 15px; }
        .chart-container { width: 800px; margin-bottom: 150px; display: none; }
        canvas { width: 100% !important; height: 400px !important; color: white; }
        h3 { font-size: 30px; font-weight: 700; margin-bottom: 10px; }
        button { padding: 12px 25px; background: #a69480; color: #fff; border: none; border-radius: 5px; cursor: pointer; font-size: 16px; margin: 5px;}
        button:hover { background: #c18836; }
        #qrPopup {
            display: none;
            position: fixed;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            background: #6a3b1b;
            border: 2px solid #a69480;
            padding: 20px;
            z-index: 999;
            border-radius: 10px;
        }
        #overlay {
            display: none;
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 998;
        }
        #tabButtons { margin-bottom: 20px; }
    </style>
</head>
<body>
    <img style="width: 300px;" src="./logo-masteri-lumiere.png"/>
    <h2 style="font-size: 70px;">B·∫¢NG X·∫æP H·∫†NG B√åNH CH·ªåN</h2>
    <button id="voteBtn" style="font-weight: bold;">üó≥Ô∏è B√¨nh Ch·ªçn Ngay</button>

    <!-- N√∫t tab 4 gi·∫£i -->
    <div id="tabButtons">
        <button>üèÜ TR√åNH DI·ªÑN ·∫§N T∆Ø·ª¢NG NH·∫§T</button>
        <button>üèÜ TRANG PH·ª§C THU H√öT NH·∫§T</button>
        <button>üèÜ KH√ÅN GI·∫¢ Y√äU TH√çCH NH·∫§T</button>
        <button>üèÜ TI·∫æT M·ª§C GI·∫¢I TR√ç NH·∫§T</button>
    </div>

    <div id="charts"></div>

    <div id="overlay"></div>
    <div id="qrPopup">
        <div id="qrcode"></div>
    </div>

<script>
const SHEET_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSe3v0wzyiGRX4OpAsihI14EHTMVlruLmCMpIrOoTtZ3a_WRaWOnEJPtJjGIMDo4dIUnk0jcR6Q752V/pub?gid=519629553&single=true&output=csv";
const FORM_URL = "https://docs.google.com/forms/d/e/1FAIpQLSdwkOPcgkNrNsiDR0icNtg8YCff_e3lyk-0AGY_zQzOIlveEg/viewform";

const playerNames = ["Duy Ki√™n", "Tu·∫•n C∆∞·ªùng", "Thu Mi·ªÅn", "Giang ƒê√†o", "ƒê·∫°i H√πng", "Tr·ªçng Hi·∫øu"];
const playerColors = ["#c18836"];
const questions = ["TR√åNH DI·ªÑN ·∫§N T∆Ø·ª¢NG NH·∫§T", "TRANG PH·ª§C THU H√öT NH·∫§T", "KH√ÅN GI·∫¢ Y√äU TH√çCH NH·∫§T", "TI·∫æT M·ª§C GI·∫¢I TR√ç NH·∫§T"];

let charts = [];
let questionHeaders = [];
let lastRowCount = 0;
let isFetching = false;

// T·∫°o 4 b·∫£ng x·∫øp h·∫°ng
questions.forEach((q, idx) => {
    const container = document.createElement('div');
    container.classList.add('chart-container');
    container.id = `chart-container-${idx}`;

    const title = document.createElement('h3');
    title.innerText = q;
    container.appendChild(title);

    const leaderDiv = document.createElement('div');
    leaderDiv.classList.add('leader');
    leaderDiv.id = `leader-${idx}`;
    leaderDiv.innerText = "ƒêang l·∫•y d·ªØ li·ªáu...";
    container.appendChild(leaderDiv);

    const canvas = document.createElement('canvas');
    canvas.id = `chart-${idx}`;
    container.appendChild(canvas);

    document.getElementById('charts').appendChild(container);

    const ctx = canvas.getContext('2d');
    const chart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: playerNames,
            datasets: [{
                label: 'S·ªë phi·∫øu',
                data: Array(playerNames.length).fill(0),
                backgroundColor: playerColors,
                barThickness: 50,
                maxBarThickness: 60
            }]
        },
        options: {
            responsive: true,
            animation: { duration: 500, easing: 'easeOutQuart' },
            plugins: { legend: { display: false }, tooltip: { bodyFont: { size: 16, weight: 'bold' }, titleFont: { size: 18, weight: 'bold' } } },
            scales: {
                y: { beginAtZero: true, ticks: { precision: 0, font: { size: 16, weight: 'bold' }, color: '#fff' } },
                x: { ticks: { font: { size: 16, weight: 'bold' }, color: '#fff' }, categoryPercentage: 0.9, barPercentage: 1 }
            }
        }
    });

    charts.push({ chart, leaderDiv, questionIndex: idx });
});

// Animate chart
function animateData(chart, newData) {
    const current = chart.data.datasets[0].data.map(v => Number(v));
    const steps = 20;
    const stepData = newData.map((v, i) => (v - current[i]) / steps);
    let count = 0;

    const interval = setInterval(() => {
        if (count >= steps) {
            chart.data.datasets[0].data = newData;
            chart.options.scales.y.suggestedMax = Math.max(...newData, 1) + 1;
            chart.update();
            clearInterval(interval);
            return;
        }
        chart.data.datasets[0].data = chart.data.datasets[0].data.map((v, i) => v + stepData[i]);
        chart.options.scales.y.suggestedMax = Math.max(...chart.data.datasets[0].data, 1) + 1;
        chart.update();
        count++;
    }, 25);
}

// Fetch CSV
async function fetchAndUpdateCharts() {
    if (isFetching) return;
    isFetching = true;
    try {
        const response = await fetch(SHEET_URL + "&_ts=" + Date.now(), { cache: "no-store" });
        if (!response.ok) throw new Error('Kh√¥ng th·ªÉ truy c·∫≠p d·ªØ li·ªáu.');

        const text = await response.text();
        const result = Papa.parse(text, { header: true, skipEmptyLines: true });
        const rows = result.data;

        if (rows.length <= lastRowCount) { isFetching = false; return; } 
        const newRows = rows.slice(lastRowCount);
        lastRowCount = rows.length;

        if (rows.length > 0) {
            const allHeaders = Object.keys(rows[0]);
            questionHeaders = [allHeaders[2], allHeaders[3], allHeaders[4], allHeaders[5]];
        }

        charts.forEach(({ chart, leaderDiv, questionIndex }) => {
            let counts = Array(playerNames.length).fill(0);
            const header = questionHeaders[questionIndex];
            if (!header) return;

            newRows.forEach(row => {
                const answer = row[header]?.trim();
                if (answer) {
                    const playerIndex = playerNames.findIndex(p => p === answer);
                    if (playerIndex !== -1) counts[playerIndex]++;
                }
            });

            const updatedData = chart.data.datasets[0].data.map((v, i) => v + counts[i]);
            animateData(chart, updatedData);

            let maxVotes = Math.max(...updatedData);
            let leaders = updatedData.map((v, i) => v === maxVotes && v > 0 ? playerNames[i] : null).filter(v => v);
            leaderDiv.innerText = maxVotes > 0 ? ` ` : "Ch∆∞a c√≥ b√¨nh ch·ªçn n√†o";
        });

    } catch (err) {
        console.error(err);
        charts.forEach(({ leaderDiv }) => leaderDiv.innerText = "L·ªói t·∫£i d·ªØ li·ªáu!");
    }
    isFetching = false;
}

fetchAndUpdateCharts();
setInterval(fetchAndUpdateCharts, 5000);

// Vote QR
document.getElementById('voteBtn').addEventListener('click', () => {
    document.getElementById('overlay').style.display = 'block';
    const qrContainer = document.getElementById('qrcode');
    qrContainer.innerHTML = '';
    new QRCode(qrContainer, { text: FORM_URL, width: 600, height: 600 });
    document.getElementById('qrPopup').style.display = 'block';
});

document.getElementById('overlay').addEventListener('click', closeQR);
document.getElementById('qrPopup').addEventListener('click', (e) => e.stopPropagation());
function closeQR(){
    document.getElementById('overlay').style.display = 'none';
    document.getElementById('qrPopup').style.display = 'none';
}

// N√∫t tab hi·ªÉn th·ªã toggle b·∫£ng x·∫øp h·∫°ng
document.querySelectorAll('#tabButtons button').forEach((btn, idx) => {
    btn.addEventListener('click', () => {
        const container = document.getElementById(`chart-container-${idx}`);
        if(container.style.display === 'block'){
            container.style.display = 'none'; // ·∫©n n·∫øu click l·∫ßn 2
        } else {
            charts.forEach((c, i) => {
                document.getElementById(`chart-container-${i}`).style.display = i === idx ? 'block' : 'none';
            });
        }
    });
});
</script>
</body>
</html>
