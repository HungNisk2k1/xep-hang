<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>4 B·∫£ng X·∫øp H·∫°ng B√¨nh Ch·ªçn</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
    <style>
        body { 
            font-family: SVN-CERA, sans-serif; 
            text-align: center; 
            margin: 20px; 
            background-color: #6a3b1b; 
            color: #c18836; 
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        *{ outline: none !important; caret-color: transparent; }
        .leader { font-weight: bold; font-size: 22px; margin-bottom: 15px; }
        .chart-container { width: 800px; margin: 80px auto; }
        canvas { width: 100% !important; height: 400px !important; color: white; }
        h3 { font-size: 24px; font-weight: 600; margin-bottom: 10px; }
        button { padding: 12px 25px; background: #a69480; color: #fff; border: none; border-radius: 5px; cursor: pointer; font-size: 16px; }
        button:hover { background: #c18836; }
        #qrPopup {
            display: none;
            position: fixed;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            background: #fff;
            border: 2px solid #a69480;
            padding: 20px;
            z-index: 999;
            border-radius: 10px;
        }
        #qrPopup button { margin-top: 10px; }
        #overlay {
            display: none;
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 998;
        }
    </style>
</head>
<body>
    <img style="width: 300px;" src="./logo-masteri-lumiere.png"/>
    <h2>üìä B·∫£ng X·∫øp H·∫°ng B√¨nh Ch·ªçn</h2>
    <button id="voteBtn" style="font-weight: bold;">üó≥Ô∏è B√¨nh Ch·ªçn Ngay</button>

    <div id="charts"></div>

    <div id="overlay"></div>
    <div id="qrPopup">
        <div id="qrcode"></div>
        <button onclick="closeQR()">ƒê√≥ng</button>
    </div>

<script>
const SHEET_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSe3v0wzyiGRX4OpAsihI14EHTMVlruLmCMpIrOoTtZ3a_WRaWOnEJPtJjGIMDo4dIUnk0jcR6Q752V/pub?output=csv";
const FORM_URL = "https://docs.google.com/forms/d/e/1FAIpQLSdwkOPcgkNrNsiDR0icNtg8YCff_e3lyk-0AGY_zQzOIlveEg/viewform";

const playerNames = ["Duy Ki√™n", "Tu·∫•n C∆∞·ªùng", "Thu Mi·ªÅn", "Giang ƒê√†o", "ƒê·∫°i H√πng", "Tr·ªçng Hi·∫øu"];
const playerColors = ["#e74c3c", "#3498db", "#2ecc71", "#f1c40f", "#9b59b6", "#e67e22"];
const questions = ["Gi·∫£i : Tr√¨nh Di·ªÖn ·∫§n T∆∞·ª£ng Nh·∫•t", "Gi·∫£i : Trang Ph·ª•c Thu H√∫t Nh·∫•t", "Gi·∫£i : Kh√°n Gi·∫£ Y√™u Th√≠ch Nh·∫•t", "Gi·∫£i : Ti·∫øt M·ª•c Gi·∫£i Tr√≠ Nh·∫•t"];

let charts = [];
let questionHeaders = [];
let lastDataHash = '';
let isFetching = false;

questions.forEach((q, idx) => {
    const container = document.createElement('div');
    container.classList.add('chart-container');

    const title = document.createElement('h3');
    title.innerText = q;
    container.appendChild(title);

    const leaderDiv = document.createElement('div');
    leaderDiv.classList.add('leader');
    leaderDiv.id = `leader-${idx}`;
    leaderDiv.innerText = "ƒêang l·∫•y d·ªØ li·ªáu...";
    container.appendChild(leaderDiv);

    const canvas = document.createElement('canvas');
    canvas.id = `chart-${idx}`;
    container.appendChild(canvas);

    document.getElementById('charts').appendChild(container);

    const ctx = canvas.getContext('2d');
    const chart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: playerNames,
            datasets: [{
                label: 'S·ªë phi·∫øu',
                data: Array(playerNames.length).fill(0),
                backgroundColor: playerColors,
                barThickness: 50,
                maxBarThickness: 60
            }]
        },
        options: {
            responsive: true,
            animation: { duration: 500, easing: 'easeOutQuart' },
            plugins: { legend: { display: false }, tooltip: { bodyFont: { size: 16, weight: 'bold' }, titleFont: { size: 18, weight: 'bold' } } },
            scales: {
                y: { beginAtZero: true, ticks: { precision: 0, font: { size: 16, weight: 'bold' }, color: '#fff' } },
                x: { ticks: { font: { size: 16, weight: 'bold' }, color: '#fff' }, categoryPercentage: 0.9, barPercentage: 1 }
            }
        }
    });

    charts.push({ chart, leaderDiv, questionIndex: idx });
});

function animateData(chart, newData) {
    const current = chart.data.datasets[0].data.map(v => Number(v));
    const steps = 20;
    const stepData = newData.map((v, i) => (v - current[i]) / steps);
    let count = 0;

    const interval = setInterval(() => {
        if (count >= steps) {
            chart.data.datasets[0].data = newData;
            chart.options.scales.y.suggestedMax = Math.max(...newData, 1) + 1;
            chart.update();
            clearInterval(interval);
            return;
        }
        chart.data.datasets[0].data = chart.data.datasets[0].data.map((v, i) => v + stepData[i]);
        chart.options.scales.y.suggestedMax = Math.max(...chart.data.datasets[0].data, 1) + 1;
        chart.update();
        count++;
    }, 25);
}

async function fetchAndUpdateCharts() {
    if (isFetching) return;
    isFetching = true;
    try {
        const response = await fetch(SHEET_URL + "&_ts=" + Date.now(), { cache: "no-store" });
        if (!response.ok) throw new Error('Kh√¥ng th·ªÉ truy c·∫≠p d·ªØ li·ªáu.');

        const text = await response.text();
        const result = Papa.parse(text, { header: true, skipEmptyLines: true });
        const rows = result.data;

        const dataHash = JSON.stringify(rows);
        if (dataHash === lastDataHash) { isFetching = false; return; } // Ch·ªâ c·∫≠p nh·∫≠t khi c√≥ d·ªØ li·ªáu m·ªõi
        lastDataHash = dataHash;

        if (rows.length > 0) {
            const allHeaders = Object.keys(rows[0]);
            questionHeaders = [allHeaders[3], allHeaders[4], allHeaders[5], allHeaders[6]];
        }

        charts.forEach(({ chart, leaderDiv, questionIndex }) => {
            let counts = Array(playerNames.length).fill(0);
            const header = questionHeaders[questionIndex];
            if (!header) return;

            rows.forEach(row => {
                const answer = row[header]?.trim();
                if (answer) {
                    const playerIndex = playerNames.findIndex(p => p === answer);
                    if (playerIndex !== -1) counts[playerIndex]++;
                }
            });

            animateData(chart, counts);

            let maxVotes = Math.max(...counts);
            let leaders = counts.map((v, i) => v === maxVotes && v > 0 ? playerNames[i] : null).filter(v => v);
            leaderDiv.innerText = maxVotes > 0 ? `üèÜ D·∫´n ƒë·∫ßu: ${leaders.join(", ")} (${maxVotes} phi·∫øu)` : "Ch∆∞a c√≥ b√¨nh ch·ªçn n√†o";
        });

    } catch (err) {
        console.error(err);
        charts.forEach(({ leaderDiv }) => leaderDiv.innerText = "L·ªói t·∫£i d·ªØ li·ªáu!");
    }
    isFetching = false;
}

fetchAndUpdateCharts();
setInterval(fetchAndUpdateCharts, 5000);

document.getElementById('voteBtn').addEventListener('click', () => {
    document.getElementById('overlay').style.display = 'block';
    const qrContainer = document.getElementById('qrcode');
    qrContainer.innerHTML = '';
    new QRCode(qrContainer, { text: FORM_URL, width: 200, height: 200 });
    document.getElementById('qrPopup').style.display = 'block';
});

function closeQR() {
    document.getElementById('overlay').style.display = 'none';
    document.getElementById('qrPopup').style.display = 'none';
}
</script>
</body>
</html>
